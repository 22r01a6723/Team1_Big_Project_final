<div class="search-container">
  <!-- Header Section -->
  <div class="search-header">
    <div class="header-content">
      <h1 class="page-title">
        <mat-icon class="title-icon">search</mat-icon>
        Message Search Dashboard
      </h1>
      <p class="page-subtitle">Search and analyze messages from Elasticsearch with tenant isolation</p>
    </div>
  </div>

  <!-- Connection Status Alert -->
  <mat-card class="status-card" *ngIf="connectionError || tenantsLoading">
    <mat-card-content>
      <div class="status-content">
        <mat-icon class="status-icon" [ngClass]="connectionError ? 'error' : 'warning'">
          {{connectionError ? 'error' : 'sync'}}
        </mat-icon>
        <div class="status-text">
          <h3>{{connectionError ? 'Connection Error' : 'Loading Tenants'}}</h3>
          <p *ngIf="connectionError">{{connectionErrorMessage}}</p>
          <p *ngIf="tenantsLoading">Loading tenant IDs from Elasticsearch...</p>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Search Form -->
  <mat-card class="search-card">
    <mat-card-header>
      <mat-card-title class="card-title">
        <mat-icon>tune</mat-icon>
        Search Filters
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="searchForm" class="search-form">
        <!-- Tenant Selection -->
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Select Tenant (Required)</mat-label>
            <mat-select formControlName="tenantId"
                        (selectionChange)="onTenantChange()"
                        [panelClass]="'tenant-dropdown-panel'">
              <mat-option value="">Choose Tenant...</mat-option>
              <mat-option *ngFor="let tenant of tenantIds" [value]="tenant">
                <div class="tenant-option">
                  <mat-icon class="tenant-icon"></mat-icon>
                  <span class="tenant-name">{{tenant}}</span>
                </div>
              </mat-option>
            </mat-select>
            <mat-icon matSuffix></mat-icon>
          </mat-form-field>
        </div>

        <!-- Main Search Bar -->
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width search-input">
            <mat-label>Search messages...</mat-label>
            <input matInput
                   formControlName="keyword"
                   placeholder="Enter keywords to search in subject, body, participants, or flag descriptions"
                   (keyup.enter)="onSearch()">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>
        </div>

        <!-- Advanced Filters Toggle -->
        <div class="filter-toggle">
          <button type="button"
                  mat-stroked-button
                  color="primary"
                  (click)="showAdvancedFilters = !showAdvancedFilters"
                  class="toggle-button">
            <mat-icon>{{showAdvancedFilters ? 'expand_less' : 'expand_more'}}</mat-icon>
            Advanced Filters
          </button>
        </div>

        <!-- Advanced Filters Panel -->
        <mat-expansion-panel [expanded]="showAdvancedFilters" class="advanced-filters">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>filter_list</mat-icon>
              Advanced Search Options
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="advanced-content">
            <div class="form-row">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Network</mat-label>
                <mat-select formControlName="network">
                  <mat-option value="">All Networks</mat-option>
                  <mat-option value="email">Email</mat-option>
                  <mat-option value="slack">Slack</mat-option>
                </mat-select>
                <mat-icon matSuffix>network_check</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Flagged Status</mat-label>
                <mat-select formControlName="flagged">
                  <mat-option value="">All Messages</mat-option>
                  <mat-option [value]="true">Flagged Only</mat-option>
                  <mat-option [value]="false">Non-Flagged Only</mat-option>
                </mat-select>
                <mat-icon matSuffix>flag</mat-icon>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Team</mat-label>
                <input matInput formControlName="team" placeholder="Enter team name">
                <mat-icon matSuffix>group</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Channel</mat-label>
                <input matInput formControlName="channel" placeholder="Enter channel name">
                <mat-icon matSuffix>chat</mat-icon>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Subject</mat-label>
                <input matInput formControlName="subject" placeholder="Enter subject keywords">
                <mat-icon matSuffix>subject</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Participant ID</mat-label>
                <input matInput formControlName="participantId" placeholder="Enter participant ID">
                <mat-icon matSuffix>person</mat-icon>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Start Date</mat-label>
                <input matInput
                       [matDatepicker]="startPicker"
                       formControlName="startDate"
                       readonly>
                <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
                <mat-datepicker #startPicker></mat-datepicker>
              </mat-form-field>

              <mat-form-field appearance="outline" class="half-width">
                <mat-label>End Date</mat-label>
                <input matInput
                       [matDatepicker]="endPicker"
                       formControlName="endDate"
                       readonly>
                <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
                <mat-datepicker #endPicker></mat-datepicker>
              </mat-form-field>
            </div>
          </div>
        </mat-expansion-panel>

        <!-- Action Buttons -->
        <div class="form-actions">
          <button type="button"
                  mat-raised-button
                  color="primary"
                  (click)="onSearch()"
                  [disabled]="loading || !searchForm.get('tenantId')?.value"
                  class="search-btn">
            <mat-icon>search</mat-icon>
            {{loading ? 'Searching...' : 'Search Messages'}}
          </button>

          <button type="button"
                  mat-stroked-button
                  (click)="onClear()"
                  class="clear-btn">
            <mat-icon>clear</mat-icon>
            Clear Filters
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Results Section -->
  <mat-card class="results-card" *ngIf="searchResults.data.length > 0 || loading">
    <mat-card-header>
      <mat-card-title class="card-title">
        <mat-icon>list_alt</mat-icon>
        Search Results from Elasticsearch
        <mat-chip class="results-count" *ngIf="totalResults > 0">
          {{totalResults}} messages found
        </mat-chip>
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <!-- Loading Spinner -->
      <div class="loading-container" *ngIf="loading">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Searching messages in Elasticsearch...</p>
      </div>

      <!-- Results Table -->
      <div class="table-container" *ngIf="!loading && searchResults.data.length > 0">
        <table mat-table [dataSource]="searchResults" class="results-table">
          <!-- Message ID Column -->
          <ng-container matColumnDef="messageId">
            <th mat-header-cell *matHeaderCellDef class="header-cell">Message ID</th>
            <td mat-cell *matCellDef="let message" class="data-cell">
              <div class="message-id">
                <mat-icon class="cell-icon">tag</mat-icon>
                <span class="message-id-text">{{message.messageId}}</span>
              </div>
            </td>
          </ng-container>

          <!-- Sender Column -->
          <ng-container matColumnDef="sender">
            <th mat-header-cell *matHeaderCellDef class="header-cell">Sender</th>
            <td mat-cell *matCellDef="let message" class="data-cell">
              <div class="participant-info">
                <mat-icon class="cell-icon">person</mat-icon>
                <span [innerHTML]="getSenderWithHighlight(message.participants)"></span>
              </div>
            </td>
          </ng-container>

          <!-- Network Column -->
          <ng-container matColumnDef="network">
            <th mat-header-cell *matHeaderCellDef class="header-cell">Network</th>
            <td mat-cell *matCellDef="let message" class="data-cell">
              <mat-chip class="network-chip" [ngClass]="'network-' + message.network">
                <mat-icon>{{getNetworkIcon(message.network)}}</mat-icon>
                {{message.network | titlecase}}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Subject Column -->
          <ng-container matColumnDef="subject">
            <th mat-header-cell *matHeaderCellDef class="header-cell">Subject</th>
            <td mat-cell *matCellDef="let message" class="data-cell">
              <div class="subject-content">
                <span class="subject-text" [innerHTML]="getSubjectWithHighlight(message.content)"></span>
              </div>
            </td>
          </ng-container>

          <!-- Body Preview Column -->
          <ng-container matColumnDef="body">
            <th mat-header-cell *matHeaderCellDef class="header-cell">Body Preview</th>
            <td mat-cell *matCellDef="let message" class="data-cell">
              <div class="body-content">
                <span class="body-text" [innerHTML]="getBodyPreviewWithHighlight(message.content)"></span>
              </div>
            </td>
          </ng-container>

          <!-- Timestamp Column -->
          <ng-container matColumnDef="timestamp">
            <th mat-header-cell *matHeaderCellDef class="header-cell">Timestamp</th>
            <td mat-cell *matCellDef="let message" class="data-cell">
              <div class="timestamp-info">
                <mat-icon class="cell-icon">access_time</mat-icon>
                <span>{{formatDate(message.timestamp)}}</span>
              </div>
            </td>
          </ng-container>

          <!-- Channel Column -->
          <ng-container matColumnDef="channel">
            <th mat-header-cell *matHeaderCellDef class="header-cell">Channel</th>
            <td mat-cell *matCellDef="let message" class="data-cell">
              <div class="channel-info">
                <mat-icon class="cell-icon">chat</mat-icon>
                <span>{{message.context?.channel || message.context?.team || 'No Channel'}}</span>
              </div>
            </td>
          </ng-container>

          <!-- Flagged Status Column -->
          <ng-container matColumnDef="flagged">
            <th mat-header-cell *matHeaderCellDef class="header-cell">Status</th>
            <td mat-cell *matCellDef="let message" class="data-cell">
              <div class="flag-status">
                <mat-chip *ngIf="message.flagged" class="flagged-chip">
                  <mat-icon>flag</mat-icon>
                  Flagged
                </mat-chip>
                <mat-chip *ngIf="!message.flagged" class="normal-chip">
                  <mat-icon>check_circle</mat-icon>
                  Normal
                </mat-chip>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"
              class="table-row"
              [class.flagged-row]="row.flagged"></tr>
        </table>

        <!-- Paginator -->
        <mat-paginator
          [length]="totalResults"
          [pageSize]="pageSize"
          [pageSizeOptions]="[10, 20, 50, 100]"
          (page)="onPageChange($event)"
          showFirstLastButtons
          class="paginator">
        </mat-paginator>
      </div>

      <!-- No Results -->
      <div class="no-results" *ngIf="!loading && searchResults.data.length === 0 && searchPerformed">
        <mat-icon class="no-results-icon">search_off</mat-icon>
        <h3>No messages found in Elasticsearch</h3>
        <p>Try adjusting your search filters or keywords for tenant "{{searchForm.get('tenantId')?.value}}"</p>
        <p class="help-text">Make sure messages are being indexed to Elasticsearch from Kafka topic 'search-topic'</p>
      </div>

      <!-- No Tenant Selected -->
      <div class="no-tenant" *ngIf="!searchPerformed && !loading">
        <mat-icon class="no-tenant-icon"></mat-icon>
        <h3>Select a tenant to start searching</h3>
        <p>Choose a tenant from the dropdown above to search messages with proper isolation</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>
